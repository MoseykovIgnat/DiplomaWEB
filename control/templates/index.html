{% extends "base.html" %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/d3-context-menu.css' %}">
{% block content %}


	<h1 align="center">Результаты условий</h1 >

<div class="row justify-content-center main-info">
        {% load static %}
    <div class="col-sm-5 text-center">
    	<div>        	
        	<table class="table table-condensed table-hover" id="condTable">
                <tr>
                    <th>Инфо</th>
                    <th>Название условия</th>
                    <th>Результат</th>
                    <th>Сирена</th>
                </tr>
                <tr class="Cond_res"></tr>
            </table>
        </div>        
    </div>

        <div class="info text-center col-sm-5">
            <div>
              <h1></h1>
              <svg width="598" height="299" style="background-image: url({% static 'img/img.png' %}); border: 4px double darkblue;">
              <defs>
                <marker id="end-arrow" viewBox="0 -5 10 10" refX="32" markerWidth="3.5" markerHeight="3.5" orient="auto">
                  <path d="M0,-5L10,0L0,5"></path>
                </marker>
                <marker id="mark-end-arrow" viewBox="0 -5 10 10" refX="7" markerWidth="3.5" markerHeight="3.5" orient="auto">
                  <path d="M0,-5L10,0L0,5"></path>
                </marker>
              </defs>
              <g class="graph">
                <g></g>
                <g>
                  <g class="conceptG" transform="translate(374,53)">
                    <circle r="5" data-condname="NULL" fill="blue"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(374,78)">
                    <circle r="5" data-condname="NULL"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(374,104)">
                    <circle r="5" data-condname="NULL"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(374,133)">
                    <circle r="5" data-condname="NULL"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(374,161)">
                    <circle r="5" data-condname="NULL"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(573,108)">
                    <circle r="5" data-condname="NULL"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(573,94)">
                    <circle r="5" data-condname="NULL"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(573,80)">
                    <circle r="5" data-condname="NULL"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(573,66)">
                    <circle r="5" data-condname="NULL"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(368,185)">
                    <circle r="5" data-condname="NULL"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                </g>
              </g>
            </svg>
        </div>
        </div>
</div>
<div class="row justify-content-around text-center main-info">
	  <div>
            <h1>Параметры в Базе данных</h1>
            <table class="table table-responsive table-condensed table-hover" id='varTable'>
                <tr>
                    <th>Путь</th>
                    <th>Результат</th>
                    <th>Дата обновления</th>
                </tr>
                <tr class="Sc_results_data"></tr>
            </table>
        </div>
</div>  

<!--     <div>


{#    Форма для POST#}
{#    <form method="POST" id="post-form">#}
{#  {% csrf_token %}#}
{#  <div class="form-group">#}
{#    <label>path</label>#}
{#    <input type="text" class="form-control" id="path" placeholder="Path">#}
{#  </div>#}
{#   <div class="form-group">#}
{#     <label>interval_time</label>#}
{#     <textarea class="form-control" id="interval_time" placeholder="interval_time"></textarea>#}
{#   </div>#}
{#   <button type="submit" class="btn btn-primary">Submit</button>#}
{#    </form>#}

    </div> -->






{% endblock %}

{% block javascript %}
{#    Contex menu for circles#}
    {% load static %}
    <script src="{% static 'js/d3-context-menu.js' %}"></script>
    <script>

		// My menu
        var conditions = [];
        $.ajax({
                    type: 'GET',
                    url: "{% url 'get_conditions' %}",
                    datatype: 'json',

                    success: function (response) {
                        conditions = response;
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
		var menu = [
		{
            title: function () {
                    return 'Name of condition: ' + d3.select(this).attr("data-condname");
                }
			},
		{

            title: 'Change Condition',
            children: function() {
                return conditions.map(function(condition) {
                    return {
                        title: condition,
                        action: function (data, event) {
                            console.log('condition changed from ' + data + ' to ' + condition);
                            d3.select(this)
                                .datum(condition)
                                .attr('data-condname', condition);
                        },

                    }
                })
            }

        },


		]
		var selection = d3.selectAll('circle')

		selection.on('contextmenu', d3.contextMenu(menu, {
				onOpen: function (data, event) {
					var index = selection.nodes().indexOf(this);
					console.log('Menu Opened!', 'element:', this, 'data:', data, 'event:', event, 'index:', index);
				},
				onClose: function (data, event) {
					var index = selection.nodes().indexOf(this);
					console.log('Menu Closed!', 'element:', this, 'data:', data, 'event:', event, 'index:', index);
				},
				position: function (data, event) {
					var bounds = this.getBoundingClientRect();
					if (data === 'green') {
						// first circle will have the menu aligned top-right
						return {
							left: bounds.left + bounds.width + 10,
							top: bounds.top
						}
					}
				}
			})); // attach menu to element
	</script>

    <script>
    window.onload = function () {
      update_info_about_variables();
      update_info_about_conditions();
    };
    </script>

    <script>

    function change_color(){
            $.ajax({
            type: 'GET',
            url: "{% url 'update_leds' %}",
            datatype: 'json',

            success: function (response) {

                {#console.log(response);#}
                d3.selectAll('circle').each(function(d){
                    if (d3.select(this).attr("data-condname")==='NULL'){
                    d3.select(this).attr('fill','black');
                    }
                    else{
                        for (i = 0; i < response.length; i++) {
                            if (response[i]['cond_name']===d3.select(this).attr("data-condname")){
                                if(response[i]['bool_result']===1){
                                    d3.select(this).attr('fill','green');
                                }
                                if(response[i]['bool_result']===0) {
                                    d3.select(this).attr('fill','red');
                                }
                            }
                        }

                    }
                })
            },
            error: function (response) {
                console.log(response)
            }
        });


    }
    function update_info_about_variables(){
                $.ajax({
            type: 'GET',
            url: "{% url 'update_info_about_variables' %}",
            datatype: 'json',

            success: function (response) {
                    var submission_date;
                    $('.Sc_results_data').remove();
                for (i = 0; i < response.length; i++) {
                    submission_date = new Date(response[i]['fields']['submission_date']);
                    submission_date.toISOString();
                    submission_date = moment(submission_date.toISOString()).subtract(7,"hours").format('DD-MM-YYYY, H:MM:ss');
                    $('#varTable').append('<tr class="Sc_results_data"><td>' + response[i]['pk'] + '</td><td>' + response[i]['fields']['value'] + '</td><td>' + submission_date + '</td>');
                }

            },
            error: function (response) {
                console.log(response)
            }
        });
    }
    function update_info_about_conditions(){
                $.ajax({
            type: 'GET',
            url: "{% url 'update_info_about_conditions' %}",
            datatype: 'json',

            success: function (response) {

                    $('.Cond_res').remove()
                    $('#condTable caption').remove()
                if (response.length===0) {
                    $('#condTable').prepend('<caption style="display: table-caption; text-align: center;">Данные отсутствуют</caption>');
                }
                else {
                for (i = 0; i < response.length; i++) {
                    time_calc = new Date(response[0]['time_calc']);
                    time_calc.toISOString();
                    time_calc = moment(time_calc.toISOString()).format('DD-MM-YYYY, h:mm:ss');
                    var condTitle = 'Info about condition:&#013' + (response[i]['time_calc'] ? 'The condition was calculated in ' + time_calc +'&#013' : '')  + (response[i]['result_formula'] ? 'Result formula: ' + response[i]['result_formula']+'&#013' : '') + (response[i]['val_formula'] ? 'Value Formula: ' + response[i]['val_formula']+'&#013' : '')+ (response[i]['text_formula'] ? 'Text Formula: ' + response[i]['text_formula']+'&#013' : '')+ (response[i]['empty_values'] ? 'This sample(s) is(are) empty: ' + response[i]['empty_values']+'&#013' : '');
                    var condInfo = '<td title="'+ condTitle +'">&times;</td>';
                    var sirenOption = (response[i]['display_method'] === 'Text+Siren' ? 'Yes!':'No!');
                    var result;
                    if (response[i]['empty_values']){
                        result='Empty value!';
                    } else {
                        if (response[i]['bool_result']===0 || response[i]['bool_result']===1) {
                            if (response[i]['bool_result']===0){
                                result = 'False';
                            }

                            if (response[i]['bool_result']===1){
                                result = 'True';
                            }
                        }
                        else {
                            result = response[i]['val_result'];
                        }
                    }
                    $('#condTable').append('<tr class="Cond_res">'+condInfo+'<td>' + response[i]['name'] + '</td>+<td>' + result + '</td>+<td>' + sirenOption + '</td>');


                }}
            },
            error: function (response) {
                console.log(response)
            }
        });
    }

    $(document).ready(function (){
        setInterval(change_color,5000);
        setInterval(update_info_about_variables,5000);
        setInterval(update_info_about_conditions,5000);
    })
{##}
{#        $('button').on('click',function (e) {#}
{#        e.preventDefault();#}
{#        // GET AJAX request#}
{#        $.ajax({#}
{#            type: 'GET',#}
{#            url: "{% url 'display_data' %}",#}
{#            datatype: 'json',#}
{##}
{#            success: function (response) {#}
{#                    for(i=0;i<response.length;i++) {#}
{#                    $('#success').append('<tr><td>'+response[i]['pk']+'</td><td>'+response[i]['fields']['value']+'</td><td>'+response[i]['fields']['flag']+'</td><td>'+response[i]['fields']['submission_date']+'</td><td>');#}
{#                    }#}
{##}
{#            },#}
{#            error: function (response) {#}
{#                console.log(response)#}
{#            }#}
{#        })#}
{#    })#}
    </script>

{#    <script>#}
    {#Форма с POST#}
{#    $(document).on('submit', '#post-form',function(e){#}
{#        e.preventDefault();#}
{#    $.ajax({#}
{#        type:'POST',#}
{#        url : "{% url 'create_post' %}",#}
{#        data:{#}
{#            path:$('#path').val(),#}
{#            interval_time:$('#interval_time').val(),#}
{#            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),#}
{#            action: 'post'#}
{#        },#}
{#        success:function(json){#}
{#            document.getElementById("post-form").reset();#}
{#            $("body").prepend(#}
{#                    `#}
{#                    <p>${json.path}</p>#}
{#                    `#}
{#                )#}
{#            $(".info").prepend('<div class="col-md-6">'+#}
{#                '<div class="row no-gutters border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">' +#}
{#                    '<div class="col p-4 d-flex flex-column position-static">' +#}
{#                        '<h3 class="mb-0">' + json.path + '</h3>' +#}
{#                        '<p class="mb-auto">' + json.interval_time + '</p>' +#}
{#                    '</div>' +#}
{#                '</div>' +#}
{#            '</div>'#}
{#            )#}
{#        },#}
{#        error : function(xhr,errmsg,err) {#}
{#        console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console#}
{#    }#}
{#    });#}
{#});#}
{#</script>#}

<script>

</script>

{% endblock javascript %}

