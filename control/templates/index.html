{% extends "base.html" %}
{% load static %}
<link rel="stylesheet" href="{% static 'css/d3-context-menu.css' %}">
{% block content %}




<div class="row justify-content-center main-info mt-5" style="padding-top: 3%">

        {% load static %}
    <div class="col-sm-5 text-center">
        <h1 align="center">Required results of conditions</h1 >

    	<div>
        	<table class="table table-condensed table-hover shadow p-4 mb-4 bg-white" id="required_condTable">
                <tr class="row-of-data">
                    <th>Инфо</th>
                    <th>Название условия</th>
                    <th>Результат</th>
                    <th>Сирена</th>
                </tr>
            </table>
        </div>

        <h1 align="center">Results of your conditions</h1 >

    	<div>        	
        	<table class="table table-condensed table-hover shadow p-4 mb-4 bg-white" id="unrequired_condTable">
                <tr class="row-of-data">
                    <th>Инфо</th>
                    <th>Название условия</th>
                    <th>Результат</th>
                    <th>Сирена</th>
                </tr>
            </table>
        </div>

    </div>

        <div class="info text-center col-sm-5">
            <h1 align="center">Indicators results</h1 >
            <div>
              <h1></h1>
              <svg data-graph_name="Processes and DB" width="598" height="299" style="background-image: url({% static 'img/img.png' %}); border: 4px double darkblue;">
              <defs>
                <marker id="end-arrow" viewBox="0 -5 10 10" refX="32" markerWidth="3.5" markerHeight="3.5" orient="auto">
                  <path d="M0,-5L10,0L0,5"></path>
                </marker>
                <marker id="mark-end-arrow" viewBox="0 -5 10 10" refX="7" markerWidth="3.5" markerHeight="3.5" orient="auto">
                  <path d="M0,-5L10,0L0,5"></path>
                </marker>
              </defs>
              <g class="graph">
                <g></g>
                <g>
                  <g class="conceptG" transform="translate(374,53)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="1"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(374,78)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="2"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(374,104)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="3"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(374,133)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="4"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(374,161)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="5"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(573,108)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="6"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(573,94)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="7"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(573,80)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="8"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(573,66)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="9"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                  <g class="conceptG" transform="translate(368,185)">
                    <circle r="5" data-cond_name="NULL" data-dot_name="NULL" data-dot_id_in_graph="10"></circle>
                    <text text-anchor="middle" dy="-0">
                      <tspan></tspan>
                    </text>
                  </g>
                </g>
              </g>
            </svg>
        </div>
        </div>
    <div class="col-auto text-center">
            <h1>Parameters in database</h1>
            {% if info %}
            <table class="table table-responsive table-condensed table-hover shadow p-4 mb-4 bg-white" id='varTable'>
                <tr>
                    <th>Путь</th>
                    <th>Результат</th>
                    <th>Комментарий</th>
                    <th>Дата обновления</th>
                </tr>
                <tr class="Sc_results_data"></tr>
            </table>

            {% else %}
                <p>У вас нет данных</p>
            {% endif %}
    </div>
</div>

<div id="rename_dot_name" class="modal fade" tabindex="-1" role="dialog" aria-labelledby="exampleModalLabel" aria-hidden="true">
  <div class="modal-dialog" role="document">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="exampleModalLabel">Добавление новой переменной</h5>
        <button type="button" class="close"  data-dismiss="modal" aria-label="Close">
          <span aria-hidden="true">&times;</span>
        </button>
      </div>
      <div class="modal-body" >
             <form method="POST" id="post_new_dot_name">
            {% csrf_token %}
            <div class="form-group">
                <label style="color: black; text-align: center">Path</label>
                <input id="input_for_name_of_dot" type="text" class="form-control collectes-date-chargement-min text-center" id="path" value="input name of dot">
            </div>
            <button type="submit" class="btn btn-primary">Submit</button>
            </form>
      </div>
    </div>
  </div>
  </div>
{% endblock %}

{% block javascript %}
{#    Contex menu for circles#}
    {% load static %}
    <script src="{% static 'js/d3-context-menu.js' %}"></script>
    <script>
		// My menu
        var conditions = [];
        var rename_node_modal_active = false;
        var old_dot_name = null;
        var dot_graph_name = null;
        var dot_id_in_graph = null;
        var node_to_rename = null;
        var new_dot_condition = null;
        var old_dot_condition = null;
        $.ajax({
                    type: 'GET',
                    url: "{% url 'get_conditions' %}",
                    datatype: 'json',

                    success: function (response) {
                        conditions = response;
                    },
                    error: function (response) {
                        console.log(response);
                    }
                });
        {% load control_extras %}
        {% if request.user|has_group:"Expert" %}
		var menu = [
		{
            title: function () {
                    return 'Name of dot: ' + d3.select(this).attr("data-dot_name");
                }
			},
        {
            title: function () {
                    return 'Name of condition: ' + d3.select(this).attr("data-cond_name");
                }
			},
        {
                title: 'Change the dot name',
                action: function() {
                        console.log('Rename node');
                        old_dot_name = d3.select(this).attr("data-dot_name");
                        dot_id_in_graph = d3.select(this).attr("data-dot_id_in_graph");
                        dot_graph_name = d3.select(this.parentNode.parentNode.parentNode.parentNode).attr("data-graph_name");
                        node_to_rename = d3.select(this);
                        $("#input_for_name_of_dot").val(old_dot_name);
                        $('#rename_dot_name').modal('show');
                        $("#RenameNodeName").focus();
                }
        },
        {

            title: 'Change the condition name',
            children: function() {
                return conditions.map(function(condition) {
                    return {
                        title: condition,
                        action: function (data, event) {
                            console.log('Change condition of dot');
                            dot_id_in_graph = d3.select(this).attr("data-dot_id_in_graph");
                            dot_graph_name = d3.select(this.parentNode.parentNode.parentNode.parentNode).attr("data-graph_name");
                            new_dot_condition = condition
                            node_to_rename = d3.select(this);
                            old_dot_condition = d3.select(this).attr("data-cond_name");
                            $.ajax({
                                type:'POST',
                                url : "{% url 'change_dot_condition' %}",
                                data:{
                                    new_dot_condition: new_dot_condition,
                                    dot_graph_name: dot_graph_name,
                                    dot_id_in_graph : dot_id_in_graph,
                                    csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
                                    action: 'post'
                                },
                                success: function (response) {
                                            alert('condition changing from ' + old_dot_condition + ' to ' + new_dot_condition);
                                            node_to_rename.attr('data-cond_name', new_dot_condition)

                                    },
                                error : function(xhr,errmsg,err) {
                                console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
                            }
                            });
                        },

                    }
                })
            }

        },

		]
        {% elif request.user %}
          var menu = [
		{
            title: function () {
                    return 'Name of dot: ' + d3.select(this).attr("data-dot_name");
                }
        },
        {
            title: function () {
                    return 'Name of condition: ' + d3.select(this).attr("data-cond_name");
                }
        },]
        {% endif %}
		var selection = d3.selectAll('circle')

		selection.on('contextmenu', d3.contextMenu(menu, {
				onOpen: function (data, event) {
					var index = selection.nodes().indexOf(this);
					console.log('Menu Opened!', 'element:', this, 'data:', data, 'event:', event, 'index:', index);
				},
				onClose: function (data, event) {
					var index = selection.nodes().indexOf(this);
					console.log('Menu Closed!', 'element:', this, 'data:', data, 'event:', event, 'index:', index);
				},
				position: function (data, event) {
					var bounds = this.getBoundingClientRect();
					if (data === 'green') {
						// first circle will have the menu aligned top-right
						return {
							left: bounds.left + bounds.width + 10,
							top: bounds.top
						}
					}
				}
			})); // attach menu to element

{% comment %}        function rename_node() {
        if (node_to_rename && rename_node_modal_active) {
                name = $('#RenameNodeName').val();
                console.log('New Node name: ' + name);
                node_to_rename.name = name;
                rename_node_modal_active = false;

        }
        close_modal();
        alert('New name '+ name);
}{% endcomment %}
	</script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.17/d3.js"></script>
    <script>
    $(document).on('submit', '#post_new_dot_name',function(e){
        e.preventDefault();
        var new_name = $('#input_for_name_of_dot').val();
    $.ajax({
        type:'POST',
        url : "{% url 'rename_dot_name' %}",
        data:{
            new_name: new_name,
            old_dot_name: old_dot_name,
            dot_graph_name: dot_graph_name,
            dot_id_in_graph : dot_id_in_graph,
            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
            action: 'post'
        },
        success: function (response) {
                    alert('done');
                    $('#rename_dot_name').modal('hide');
                    node_to_rename.attr('data-dot_name', new_name)

            },
        error : function(xhr,errmsg,err) {
        console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
    }
    });
});
</script>
    <script>

    function change_color(){
            $.ajax({
            type: 'GET',
            url: "{% url 'update_leds' %}",
            datatype: 'json',

            success: function (response) {

                {#console.log(response);#}
                d3.selectAll('circle').each(function(d){
                    if (d3.select(this).attr("data-cond_name")==='NULL'){
                    d3.select(this).attr('fill','black');
                    }
                    else{
                        for (i = 0; i < response.length; i++) {
                            if (response[i]['cond_name']===d3.select(this).attr("data-cond_name")){
                                if(response[i]['bool_result']===1){
                                    d3.select(this).attr('fill','green');
                                }
                                if(response[i]['bool_result']===0) {
                                    d3.select(this).attr('fill','red');
                                }
                            }
                        }

                    }
                })
            },
            error: function (response) {
                console.log(response)
            }
        });


    }
    function update_info_in_graphs(){
        $.ajax({
            type: 'GET',
            url: "{% url 'update_info_in_graphs' %}",
            datatype: 'json',
            success: function (response) {
            d3.selectAll('circle').each(function(d){
                    for (i = 0; i < response.length; i++) {

                        if (String(response[i]['dot_id_in_graph'])===d3.select(this).attr("data-dot_id_in_graph") && response[i]['graph__graph_name']===d3.select(this.parentNode.parentNode.parentNode.parentNode).attr("data-graph_name")){
                            d3.select(this).attr('data-cond_name',response[i]['dot_condition']);
                            d3.select(this).attr('data-dot_name',response[i]['dot_name']);
                        }
                    }


                })


            },
            error: function (response) {
                console.log(response)
            }
        });
    }
    function update_info_about_variables(){
                $.ajax({
            type: 'GET',
            url: "{% url 'update_info_about_variables' %}",
            datatype: 'json',

            success: function (response) {
                    var comment;
                    var submission_date;
                    $('.Sc_results_data').remove()
                for (i = 0; i < response.length; i++) {
                    submission_date = new Date(response[i]['fields']['submission_date']);
                    submission_date.toISOString();
                    submission_date = moment(submission_date.toISOString()).subtract(7,"hours").format('MMMM DD, YYYY, HH:mm:ss');
                    if (!response[i]['fields']['comment']){
                        comment = 'Ok';
                    }
                    else{
                        comment = response[i]['fields']['comment'];
                    }
                    $('#varTable').append('<tr class="Sc_results_data"><td>' + response[i]['pk'] + '</td><td>' + response[i]['fields']['value'] + '</td><td>' + comment + '</td><td>' + submission_date + '</td>');
                }

            },
            error: function (response) {
                console.log(response)
            }
        });
    }
    function update_info_about_conditions(){
                $.ajax({
            type: 'GET',
            url: "{% url 'update_info_about_conditions' %}",
            datatype: 'json',

            success: function (response) {

                    $('.required_cond_res').remove()
                    $('.unrequired_cond_res').remove()
                    $('#required_condTable caption').remove()
                    $('#unrequired_condTable caption').remove()
                for (var key in response){
                    var table_id = key === 'required' ? $('#required_condTable') : $('#unrequired_condTable');
                    var class_name = key === 'required' ? 'required_cond_res' : 'unrequired_cond_res';
                    if (response[key].length===0) {
                        table_id.prepend('<caption style="display: table-caption; text-align: center;">Данные отсутствуют</caption>');
                    }
                    else {
                        for (i = 0; i < response[key].length; i++) {
                            time_calc = new Date(response[key][0]['time_calc']);
                            time_calc.toISOString();
                            time_calc = moment(time_calc.toISOString()).subtract(7,"hours").format('MMMM DD, YYYY, HH:mm:ss');
                            var condTitle = 'Info about condition: &#013' + (response[key][i]['time_calc'] ? 'The condition was calculated in ' + time_calc +'&#013' : '')  + (response[key][i]['creator_of_the_condition'] ? 'Creator of the condition:  ' + response[key][i]['creator_of_the_condition'] +'&#013' : '')  + (response[key][i]['result_formula'] ? 'Result formula: ' + response[key][i]['result_formula']+'&#013' : '') + (response[key][i]['val_formula'] ? 'Value Formula: ' + response[key][i]['val_formula']+'&#013' : '')+ (response[key][i]['text_formula'] ? 'Text Formula: ' + response[key][i]['text_formula']+'&#013' : '') + (response[key][i]['empty_values'] ? 'This sample(s) is(are) empty: ' + response[key][i]['empty_values']+'&#013' : '') + (response[key][i]['condition_tags'] ? 'Condition tags: ' + response[key][i]['condition_tags']+'&#013' : '');
                            var condInfo = '<td title="'+ condTitle +'">&times;</td>';
                            var sirenOption = ( (response[key][i]['alert_interval']) && (response[key][i]['priority']) ? (response[key][i]['display_method'] === "Text+Siren") ? '<button id="change_display_method">' + 'Yes' + '</button>':'<button id="change_display_method">' + 'No' + '</button>':'No!');
                            var result;
                            if (response[key][i]['empty_values']){
                                result='Empty value!';
                            } else {
                                if (response[key][i]['bool_result']===0 || response[key][i]['bool_result']===1) {
                                    if (response[key][i]['bool_result']===0){
                                        result = 'False';
                                    }

                                    if (response[key][i]['bool_result']===1){
                                        result = 'True';
                                    }
                                }
                                else {
                                    result = response[key][i]['val_result'];
                                }
                            }
                            table_id.append('<tr class=' + class_name + '>'+condInfo+'<td id="cond_name_in_table" data-name-of-creator="'+response[key][i]['creator_of_the_condition']+ '">' + response[key][i]['name'] + '</td>+<td>' + result + '</td>+<td>' + sirenOption + '</td>');


                        }
                    }
                }
            },
            error: function (response) {
                console.log(response);

            }
        });
    }



    $(document).ready(function (){
        update_info_in_graphs();
        update_info_about_variables();
        update_info_about_conditions();
        change_color();
        setInterval(change_color,5000);
        setInterval(update_info_about_variables,5000);
        setInterval(update_info_about_conditions,5000);
    })
    </script>

<script>
    $(document).on('click',"#change_display_method",function (e){
        e.preventDefault();
        var button = $(this);
        var rowOfData = $(this).parents("tr");
        var creator = rowOfData.children('#cond_name_in_table').attr("data-name-of-creator")
        var condName = rowOfData.children('#cond_name_in_table').html()
        $.ajax({
            type:'POST',
            url : "{% url 'change_condition_display_method' %}",
            data:{
                csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),
                action: 'post',
                creator: String(creator),
                cond_name: condName,
            },
            success: function (response) {
                if (button.text() === "Yes"){
                    button.text('No');
                }
                else{
                    button.text('Yes');
                }


                },
            error : function(xhr,errmsg,err) {
            console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console
        }
        });
    });
</script>

{#    <script>#}
    {#Форма с POST#}
{#    $(document).on('submit', '#post-form',function(e){#}
{#        e.preventDefault();#}
{#    $.ajax({#}
{#        type:'POST',#}
{#        url : "{% url 'create_post' %}",#}
{#        data:{#}
{#            path:$('#path').val(),#}
{#            interval_time:$('#interval_time').val(),#}
{#            csrfmiddlewaretoken:$('input[name=csrfmiddlewaretoken]').val(),#}
{#            action: 'post'#}
{#        },#}
{#        success:function(json){#}
{#            document.getElementById("post-form").reset();#}
{#            $("body").prepend(#}
{#                    `#}
{#                    <p>${json.path}</p>#}
{#                    `#}
{#                )#}
{#            $(".info").prepend('<div class="col-md-6">'+#}
{#                '<div class="row no-gutters border rounded overflow-hidden flex-md-row mb-4 shadow-sm h-md-250 position-relative">' +#}
{#                    '<div class="col p-4 d-flex flex-column position-static">' +#}
{#                        '<h3 class="mb-0">' + json.path + '</h3>' +#}
{#                        '<p class="mb-auto">' + json.interval_time + '</p>' +#}
{#                    '</div>' +#}
{#                '</div>' +#}
{#            '</div>'#}
{#            )#}
{#        },#}
{#        error : function(xhr,errmsg,err) {#}
{#        console.log(xhr.status + ": " + xhr.responseText); // provide a bit more info about the error to the console#}
{#    }#}
{#    });#}
{#});#}
{#</script>#}

<script>

</script>

{% endblock javascript %}